<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>burak.wtf</title>

<style>
  body{
    margin:0; height:100vh;
    display:flex; align-items:center; justify-content:center;
    background:#0b0f1a; font:14px monospace; color:#eee;
  }
  .page{ display:flex; align-items:center; justify-content:center; gap:8vw; padding:24px; }
  .window{ background:#101624; border:2px solid #1f2a3d; border-radius:6px; width:340px; box-shadow:0 0 20px rgba(0,0,0,.6) }
  .titlebar{ background:#182235; padding:6px 10px; font-weight:bold; font-size:13px; border-bottom:1px solid #1f2a3d }
  .content{ padding:14px; display:flex; flex-direction:column; gap:12px }
  .btn{ display:block; padding:10px 12px; background:#131b2c; border:1px solid #24314a; border-radius:4px; text-align:center; color:#eee; text-decoration:none; transition:background .15s,border-color .15s }
  .btn:hover{ background:#1a2540; border-color:#2f4466 }
  .right{ min-width:280px; display:flex; flex-direction:column; align-items:center; gap:16px; }
  .quote{ white-space:pre; text-align:center; line-height:1.4; opacity:.9; }
  .reserve-panel{ width:280px; display:flex; flex-direction:column; gap:10px; margin-top:10px; }
  .reserve-panel label span{ display:block; font-size:12px; opacity:.65; margin:0 0 6px 2px; }
  .reserve-panel input{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid #2a3556; background:#0b1220; color:#e7ebf3; outline:none; }
  .reserve-panel input:focus{ border-color:#3b82f6 }
  .reserve-panel button{ width:100%; padding:10px 12px; border:0; border-radius:8px; background:#1f6feb; color:#fff; font-weight:600; cursor:pointer; }
  .reserve-panel button:disabled{ opacity:.6; cursor:not-allowed }
  .reserve-panel .msg{ min-height:18px; font-size:12px; margin:4px 0 0; opacity:.85 }
</style>

<body>
  <div class="page">
    <!-- SOL panel (aynı düzen) -->
    <div class="window">
      <div class="titlebar">burak.wtf</div>
      <div class="content">
        <a class="btn" href="apps/breatheye/index.html">BreaThEye</a>
        <a class="btn" href="apps/t0kenumbers/index.html">t0kenumbers</a>
        <a class="btn" href="https://ch4t.burak.wtf">ch4t</a>
        <a class="btn" href="apps/fun/v0.1.2.html">contactography button</a>
        <a class="btn" href="apps/lightv0(app)/index.html">chatgpt's breath</a>
      </div>
    </div>

    <!-- SAĞ panel -->
    <div class="right">
      <div class="quote">   May the Force
  be
   with No 01</div>
      <div id="authArea"></div>
    </div>
  </div>
  <!-- ACCOUNT WIDGET -->
  <section id="account" class="account-panel">
    <div class="card">
      <h3>account</h3>

      <div id="acct-signed-out">
        <label>
          <span>nick</span>
          <input id="acc-nick" type="text" autocomplete="username" placeholder="pick a nickname">
        </label>
        <label>
          <span>pass</span>
          <input id="acc-pass" type="password" autocomplete="current-password" placeholder="set a password">
        </label>
        <div class="row">
          <button id="btn-create">reserve (create)</button>
          <button id="btn-login">log in</button>
        </div>
        <p id="acc-msg" class="msg"></p>
      </div>

      <div id="acct-signed-in" class="hidden">
        <p>Signed in as <b id="who"></b></p>
        <div class="row">
          <button id="btn-logout">log out</button>
        </div>
        <p id="acc-msg-in" class="msg"></p>
      </div>
    </div>
  </section>

  <style>
    .account-panel{ position:fixed; right:2rem; bottom:2rem; z-index:50; }
    .card{ background:#0f172a; border:1px solid #1f2937; padding:16px; width:300px; border-radius:14px; box-shadow:0 8px 30px rgba(0,0,0,.35) }
    .card h3{ margin:0 0 8px; color:#e5e7eb; font-weight:600; }
    label{ display:flex; flex-direction:column; gap:6px; margin:8px 0; color:#cbd5e1; font-size:14px;}
    input{ background:#111827; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:10px 12px; outline:none; }
    input::placeholder{ color:#94a3b8; }
    .row{ display:flex; gap:8px; margin-top:10px; }
    button{ padding:10px 12px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; cursor:pointer; }
    button:hover{ border-color:#475569; }
    .msg{ min-height:18px; color:#94a3b8; font-size:12px; margin-top:8px; }
    .hidden{ display:none; }
  </style>
  <script>
  const API_BASE = "https://ch4t.burak.wtf";
  let CURRENT = { nick: null, token: null };

  function setStatus(t){ console.log(t); /* istersen UI'ye yaz */ }

  function authHeader() {
    try {
      const u = JSON.parse(localStorage.getItem("burak_user") || "null");
      if (u && u.token) return { Authorization: `Bearer ${u.token}` };
    } catch {}
    return {};
  }

  function saveUser(nick, token) {
    CURRENT = { nick, token };
    localStorage.setItem("burak_user", JSON.stringify(CURRENT));
  }

  async function reserve(nick, pass) {
    setStatus("reserving…");
    const res = await fetch(`${API_BASE}/api/account`, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ op: "reserve", nick, pass }),
      credentials: "include"
    });
    const data = await res.json();
    if (!data.ok) { setStatus(data.error || "reserve_failed"); return; }
    setStatus("reserved");
  }
     
  async function login(nick, pass) {
    setStatus("logging in…");
    const res = await fetch(`${API_BASE}/api/account`, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ op: "login", nick, pass }),
      credentials: "include"
    });
    const data = await res.json();
    if (!data.ok) { setStatus(data.error || "login_failed"); return; }
    // beklenen: { ok:true, token, nick }
    saveUser(data.nick, data.token);
    setStatus("");
    renderSignedIn(); // UI'ni güncelle
  }

  async function loadMe() {
      const res = await fetch(`${API_BASE}/api/me`, { headers: { ...authHeader() },
          credentials: "include"
      });
    const data = await res.json();
    if (data.ok) {
      const nick = data.nick || (data.user && data.user.nick) || null;
      if (nick) saveUser(nick, CURRENT.token || null);
    }
  }

 
      async function sendMessage(text, channel) {
        const ch = channel || CURRENT.channel || "#wtf";   // ← fallback buraya
        const res = await fetch(`${API_BASE}/api/messages?ch=${encodeURIComponent(ch)}`, {
          method: "POST",
          headers: { "content-type": "application/json", ...authHeader() },
          body: JSON.stringify({ text }),
          credentials: "include"
        });
        const data = await res.json();
        if (!data.ok) setStatus(data.error || "send_failed");
      }


  // sayfa açılışında mevcut kullanıcıyı yükle
  try { CURRENT = JSON.parse(localStorage.getItem("burak_user") || "null") || {}; } catch {}
  loadMe();
  
  // === UI helpers ===
  const $ = sel => document.querySelector(sel);

  function renderSignedIn() {
    const nick = CURRENT?.nick || "";
    $("#who").textContent = nick;
    $("#acct-signed-out").classList.add("hidden");
    $("#acct-signed-in").classList.remove("hidden");
    setStatus(""); // konsolu temiz tutalım
  }

  function renderSignedOut() {
    $("#who").textContent = "";
    $("#acct-signed-in").classList.add("hidden");
    $("#acct-signed-out").classList.remove("hidden");
    $("#acc-msg").textContent = "";
    $("#acc-msg-in").textContent = "";
  }

  function setStatusUI(text, signedIn = false) {
    // mevcut setStatus(console) kalsın; bu da UI'ye yazsın
    setStatus(text);
    const el = signedIn ? $("#acc-msg-in") : $("#acc-msg");
    if (el) el.textContent = text || "";
  }

  // === Button bindings ===
  function bindAuthUI() {
    const $nick = $("#acc-nick");
    const $pass = $("#acc-pass");
    const $btnCreate = $("#btn-create");
    const $btnLogin  = $("#btn-login");
    const $btnLogout = $("#btn-logout");

    // create (reserve)
    if ($btnCreate) $btnCreate.addEventListener("click", async () => {
      const n = ($nick?.value || "").trim();
      const p = $pass?.value || "";
      if (!n || !p) { setStatusUI("nick & pass required"); return; }
      $btnCreate.disabled = true;
      try {
        await reserve(n, p);
        setStatusUI("reserved ✓");
      } catch (e) {
        setStatusUI("reserve_failed");
      } finally {
        $btnCreate.disabled = false;
      }
    });

    // login
    if ($btnLogin) $btnLogin.addEventListener("click", async () => {
      const n = ($nick?.value || "").trim();
      const p = $pass?.value || "";
      if (!n || !p) { setStatusUI("nick & pass required"); return; }
      $btnLogin.disabled = true;
      setStatusUI("logging in…");
      try {
        await login(n, p);         // login başarılı olursa renderSignedIn() çağrılıyor
        setStatusUI("", true);
      } catch (e) {
        setStatusUI("login_failed");
      } finally {
        $btnLogin.disabled = false;
      }
    });

    // logout
    if ($btnLogout) $btnLogout.addEventListener("click", () => {
      localStorage.removeItem("burak_user");
      CURRENT = { nick:null, token:null };
      renderSignedOut();
    });
  }

  // === İlk açılışta paneli doğru kur ===
  (function initAuth() {
    // LocalStorage’dan nick varsa signed-in’e geç
    if (CURRENT?.nick) renderSignedIn(); else renderSignedOut();

    // UI olaylarını bağla
    bindAuthUI();

    // /api/me ile nick’i doğrula/yenile
    loadMe().then(() => {
      if (CURRENT?.nick) renderSignedIn();
    });
  })();
  </script>
</body>
</html>
